name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [main]
    tags:
      - "**"
  pull_request:
    branches: [main]

env:
  IMAGE_NAME: vo-nodejs-app
  REGISTRY: ghcr.io

jobs:
  static-analysis:
    name: Static Code Analysis
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4
      - run: semgrep ci --sarif > semgrep.sarif
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload SARIF file for GitHub Advanced Security Dashboard
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: semgrep.sarif
        if: always()

  build-and-scan:
    name: Build and Security Scan
    runs-on: ubuntu-latest
    needs: static-analysis
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tags
        id: image-tags
        run: |
          # Determine image tag based on event type
          if [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/heads/main ]]; then
            # Main branch push: use commit SHA and tag as latest
            IMAGE_TAG="${{ github.sha }}"
            PUSH="true"
            LATEST_TAG="true"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # Pull request: use PR head commit SHA
            IMAGE_TAG="${{ github.event.pull_request.head.sha }}"
            PUSH="false"
            LATEST_TAG="false"
          elif [ "${{ github.event_name }}" == "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Tag creation: use tag name (e.g., v1.0.0)
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"
            PUSH="true"
            LATEST_TAG="true"
          else
            # Fallback: use commit SHA
            IMAGE_TAG="${{ github.sha }}"
            PUSH="false"
            LATEST_TAG="false"
          fi

          BASE_TAG="${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"

          echo "image-tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "push=${PUSH}" >> $GITHUB_OUTPUT
          echo "latest-tag=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "base-tag=${BASE_TAG}" >> $GITHUB_OUTPUT

          echo "Determined image tag: ${IMAGE_TAG}"
          echo "Will push: ${PUSH}"
          echo "Will tag as latest: ${LATEST_TAG}"

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          load: true
          tags: ${{ steps.image-tags.outputs.base-tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner (SARIF)
        id: trivy-sarif
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          image-ref: ${{ steps.image-tags.outputs.base-tag }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Run Trivy scan (table output) - Fail on HIGH and CRITICAL vulnerabilities
        id: trivy-scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.image-tags.outputs.base-tag }}
          format: "table"
          exit-code: "1"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: false

      - name: Tag image for latest (main branch or tag creation)
        if: success() && steps.image-tags.outputs.latest-tag == 'true'
        run: |
          docker tag ${{ steps.image-tags.outputs.base-tag }} \
            ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:latest

      - name: Push image to registry (only on success and when push is enabled)
        if: success() && steps.image-tags.outputs.push == 'true'
        run: |
          docker push ${{ steps.image-tags.outputs.base-tag }}
          if [ "${{ steps.image-tags.outputs.latest-tag }}" == "true" ]; then
            docker push ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.IMAGE_NAME }}:latest
          fi

      - name: Success message
        if: success()
        run: |
          if [ "${{ steps.image-tags.outputs.push }}" == "true" ]; then
            echo "✅ All security scans passed. Image pushed successfully with tag: ${{ steps.image-tags.outputs.image-tag }}"
          else
            echo "✅ All security scans passed. Image built successfully (not pushed - PR or non-main branch). Tag: ${{ steps.image-tags.outputs.image-tag }}"
          fi
